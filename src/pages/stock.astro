---
import '../styles/global.css'
import Header from '../components/Header.astro'
---

<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <link rel='icon' type='image/svg+xml' href='/favicon.svg' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover' />
    <meta name='generator' content={Astro.generator} />
    <meta name='description' content='Calculate optimal position sizes and margin for stock trading' />
    <meta name='theme-color' content='#7c3aed' />
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
    <meta name='apple-mobile-web-app-title' content='Position Calc' />
    <link rel='apple-touch-icon' href='/apple-touch-icon.png' />
    <link rel='manifest' href='/manifest.json' />
    <title>Stock Position Size Calculator</title>
  </head>
  <body
    class='min-h-screen flex flex-col items-center p-4 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900'
  >
    <Header />
    <main
      class='bg-white/95 backdrop-blur-sm shadow-2xl p-8 w-full max-w-lg md:max-w-6xl border border-white/20'
    >
      <div class='text-center mb-8'>
        <h1
          class='text-4xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2'
        >
          Stock Position Size Calculator
        </h1>
        <p class='text-gray-600 text-sm'>
          Calculate optimal position size and margin for stock trading
        </p>
      </div>

      <div class='grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8'>
        <div>
          <form id='calcForm' class='space-y-5'>
            <div>
              <label class='block mb-2 text-sm font-semibold text-gray-700'>
                Stock Symbol
              </label>
              <input
                type='text'
                id='asset'
                placeholder='AAPL, TSLA, etc.'
                class='w-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-800'
                value='AAPL'
              />
            </div>

            <div>
              <label class='block mb-2 text-sm font-semibold text-gray-700'>
                Total Risk ($)
              </label>
              <input
                type='number'
                id='totalRisk'
                placeholder='50000'
                step='any'
                class='w-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-800'
                required
              />
            </div>

            <div class='grid grid-cols-2 gap-4'>
              <div>
                <label class='block mb-2 text-sm font-semibold text-gray-700'>
                  Entry Price ($)
                </label>
                <input
                  type='number'
                  id='entry'
                  placeholder='8'
                  step='any'
                  class='w-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-800'
                  required
                />
              </div>

              <div>
                <label class='block mb-2 text-sm font-semibold text-gray-700'>
                  Stop Loss ($)
                </label>
                <input
                  type='number'
                  id='stop'
                  placeholder='7'
                  step='any'
                  class='w-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-800'
                  required
                />
              </div>
            </div>

            <div>
              <label class='block mb-2 text-sm font-semibold text-gray-700'>
                Take Profit ($) <span class='text-gray-400 font-normal'
                  >(optional)</span
                >
              </label>
              <input
                type='number'
                id='takeProfit'
                placeholder='10'
                step='any'
                class='w-full px-4 py-3 border-2 border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-gray-800'
              />
            </div>

            <button
              type='submit'
              class='w-full py-3.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold hover:from-purple-700 hover:to-indigo-700 transform hover:scale-[1.02] transition-all duration-200 shadow-lg hover:shadow-xl'
            >
              Calculate Position Size
            </button>
          </form>
        </div>

        <div>
          <div
            id='result'
            class='md:sticky md:top-8 md:mt-7 p-6 bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 hidden animate-fade-in'
          >
            <h3
              class='text-lg font-bold text-gray-800 mb-4 flex items-center gap-2'
            >
              <span class='w-2 h-2 bg-purple-500'></span>
              Calculation Results
            </h3>
            <div class='space-y-3'>
              <div class='bg-white/80 p-4 border border-purple-100'>
                <p class='text-sm text-gray-600 mb-1'>Position Size</p>
                <p id='positionSize' class='text-2xl font-bold text-purple-700'>
                </p>
              </div>
              <div class='bg-white/80 p-4 border border-purple-100'>
                <p class='text-sm text-gray-600 mb-1'>Margin Required</p>
                <p
                  id='marginRequired'
                  class='text-xl font-bold text-indigo-700'
                >
                </p>
              </div>
              <div class='bg-white/80 p-4 border border-purple-100'>
                <p class='text-sm text-gray-600 mb-1'>Risk Per Share</p>
                <p id='riskPerShare' class='text-lg font-semibold text-gray-800'>
                </p>
              </div>
              <div
                id='profitContainer'
                class='bg-white/80 p-4 border border-purple-100 hidden'
              >
                <p class='text-sm text-gray-600 mb-1'>Total Profit</p>
                <p id='totalProfit' class='text-xl font-bold text-green-600'>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
<script>
  // Storage keys - separate from crypto calculator
  const STORAGE_KEYS = {
    asset: 'stockCalc_asset',
    totalRisk: 'stockCalc_totalRisk',
    entry: 'stockCalc_entry',
    stop: 'stockCalc_stop',
    takeProfit: 'stockCalc_takeProfit',
    results: 'stockCalc_results',
  }

  // Save form data to localStorage
  function saveFormData() {
    const formData = {
      asset: document.getElementById('asset').value,
      totalRisk: document.getElementById('totalRisk').value,
      entry: document.getElementById('entry').value,
      stop: document.getElementById('stop').value,
      takeProfit: document.getElementById('takeProfit').value,
    }

    Object.entries(formData).forEach(([key, value]) => {
      if (value) {
        localStorage.setItem(STORAGE_KEYS[key], value)
      }
    })
  }

  // Load form data from localStorage
  function loadFormData() {
    const asset = localStorage.getItem(STORAGE_KEYS.asset)
    const totalRisk = localStorage.getItem(STORAGE_KEYS.totalRisk)
    const entry = localStorage.getItem(STORAGE_KEYS.entry)
    const stop = localStorage.getItem(STORAGE_KEYS.stop)
    const takeProfit = localStorage.getItem(STORAGE_KEYS.takeProfit)

    if (asset) document.getElementById('asset').value = asset
    if (totalRisk) document.getElementById('totalRisk').value = totalRisk
    if (entry) document.getElementById('entry').value = entry
    if (stop) document.getElementById('stop').value = stop
    if (takeProfit) document.getElementById('takeProfit').value = takeProfit

    return { asset, totalRisk, entry, stop, takeProfit }
  }

  // Save results to localStorage
  function saveResults(results) {
    localStorage.setItem(STORAGE_KEYS.results, JSON.stringify(results))
  }

  // Load results from localStorage
  function loadResults() {
    const saved = localStorage.getItem(STORAGE_KEYS.results)
    return saved ? JSON.parse(saved) : null
  }

  // Format numbers appropriately
  function formatNumber(num, decimals = 6) {
    if (num >= 1000000)
      return num.toLocaleString('en-US', {
        maximumFractionDigits: decimals,
      })
    return num.toFixed(decimals).replace(/\.?0+$/, '')
  }

  // Calculate and display results
  function calculateAndDisplay(shouldScroll = false) {
    const asset =
      document.getElementById('asset').value.trim().toUpperCase() || 'STOCK'
    const totalRisk = parseFloat(document.getElementById('totalRisk').value)
    const entry = parseFloat(document.getElementById('entry').value)
    const stop = parseFloat(document.getElementById('stop').value)
    const takeProfitValue = document.getElementById('takeProfit').value
    const takeProfit = takeProfitValue ? parseFloat(takeProfitValue) : null

    if (isNaN(totalRisk) || isNaN(entry) || isNaN(stop)) {
      return false
    }

    if (stop === entry) {
      return false
    }

    if (totalRisk <= 0 || entry <= 0 || stop <= 0) {
      return false
    }

    // Calculate Risk Per Share
    const riskPerShare = entry - stop
    
    // Calculate Position Size: TotalRisk / (EntryPrice - StopLoss)
    const positionSize = totalRisk / riskPerShare
    
    // Calculate Margin Required: PositionSize * EntryPrice
    const marginRequired = positionSize * entry

    const positionEl = document.getElementById('positionSize')
    const marginEl = document.getElementById('marginRequired')
    const riskPerShareEl = document.getElementById('riskPerShare')
    const profitContainer = document.getElementById('profitContainer')
    const totalProfitEl = document.getElementById('totalProfit')
    const resultDiv = document.getElementById('result')

    positionEl.textContent = `${formatNumber(positionSize)} shares`
    marginEl.textContent = `$${marginRequired.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
    riskPerShareEl.textContent = `$${riskPerShare.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} per share`

    // Calculate and display profit if take profit is provided and higher than entry
    if (takeProfit && !isNaN(takeProfit) && takeProfit > entry) {
      const profitPerShare = takeProfit - entry
      const totalProfit = positionSize * profitPerShare
      
      totalProfitEl.textContent = `$${totalProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
      profitContainer.classList.remove('hidden')
      
      // Save results with profit
      saveResults({
        positionSize: positionSize.toString(),
        marginRequired: marginRequired.toString(),
        riskPerShare: riskPerShare.toString(),
        totalProfit: totalProfit.toString(),
        takeProfit: takeProfit.toString(),
        asset,
      })
    } else {
      profitContainer.classList.add('hidden')
      
      // Save results without profit
      saveResults({
        positionSize: positionSize.toString(),
        marginRequired: marginRequired.toString(),
        riskPerShare: riskPerShare.toString(),
        asset,
      })
    }

    resultDiv.classList.remove('hidden')

    // Only scroll when explicitly requested (button press)
    if (shouldScroll) {
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
    }

    return true
  }

  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/sw.js')
        .then(registration => {
          console.log('Service Worker registered:', registration)
        })
        .catch(error => {
          console.log('Service Worker registration failed:', error)
        })
    })
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('calcForm')
    const resultDiv = document.getElementById('result')
    const positionEl = document.getElementById('positionSize')
    const marginEl = document.getElementById('marginRequired')
    const riskPerShareEl = document.getElementById('riskPerShare')
    const profitContainer = document.getElementById('profitContainer')
    const totalProfitEl = document.getElementById('totalProfit')

    // Load saved form data
    const savedData = loadFormData()

    // Load and display saved results if form data is complete
    const savedResults = loadResults()
    if (
      savedResults &&
      savedData.totalRisk &&
      savedData.entry &&
      savedData.stop
    ) {
      positionEl.textContent = `${formatNumber(parseFloat(savedResults.positionSize))} shares`
      marginEl.textContent = `$${parseFloat(savedResults.marginRequired).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
      riskPerShareEl.textContent = `$${parseFloat(savedResults.riskPerShare).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} per share`
      
      // Show profit if it exists in saved results
      if (savedResults.totalProfit && savedResults.takeProfit) {
        const savedTakeProfit = parseFloat(savedResults.takeProfit)
        const savedEntry = parseFloat(savedData.entry)
        if (savedTakeProfit > savedEntry) {
          totalProfitEl.textContent = `$${parseFloat(savedResults.totalProfit).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
          profitContainer.classList.remove('hidden')
        } else {
          profitContainer.classList.add('hidden')
        }
      } else {
        profitContainer.classList.add('hidden')
      }
      
      resultDiv.classList.remove('hidden')
    }

    // Auto-calculate if all required fields are filled
    if (
      savedData.totalRisk &&
      savedData.entry &&
      savedData.stop
    ) {
      setTimeout(() => {
        calculateAndDisplay()
      }, 100)
    }

    // Add event listeners to all inputs to save on change
    const inputs = ['asset', 'totalRisk', 'entry', 'stop', 'takeProfit']
    inputs.forEach(id => {
      const input = document.getElementById(id)
      if (input) {
        input.addEventListener('input', () => {
          saveFormData()
          // Auto-calculate if all required fields are filled
          if (id !== 'asset') {
            setTimeout(() => {
              calculateAndDisplay()
            }, 300) // Debounce calculation
          }
        })
        input.addEventListener('change', saveFormData)
      }
    })

    if (form) {
      form.addEventListener('submit', e => {
        e.preventDefault()

        if (!calculateAndDisplay(true)) {
          const totalRisk = parseFloat(document.getElementById('totalRisk').value)
          const entry = parseFloat(document.getElementById('entry').value)
          const stop = parseFloat(document.getElementById('stop').value)

          if (
            isNaN(totalRisk) ||
            isNaN(entry) ||
            isNaN(stop)
          ) {
            alert('Please fill out all required fields.')
            return
          }

          if (stop === entry) {
            alert('Stop-loss cannot be equal to entry price.')
            return
          }

          if (totalRisk <= 0 || entry <= 0 || stop <= 0) {
            alert('All values must be greater than zero.')
            return
          }
        }
      })
    }
  })
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>

